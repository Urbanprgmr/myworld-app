<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>World Brain — Stage 2: Realization</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: monospace;
      display: flex;
      flex-direction: column;
    }
    canvas {
      background: #000;
      display: block;
      margin: 0 auto;
    }
    #ui {
      background: #1a1a1a;
      padding: 10px;
    }
    #chat {
      height: 200px;
      overflow-y: auto;
      background: #0d0d0d;
      border-top: 1px solid #333;
      padding: 10px;
      font-size: 14px;
    }
    .message { margin-bottom: 8px; }
    .brain { color: #66ff66; }
    .user { color: #33ccff; }
  </style>
</head>
<body>

<canvas id="world" width="800" height="400"></canvas>
<div id="ui">
  <div id="chat"></div>
</div>

<script>
  const canvas = document.getElementById("world");
  const ctx = canvas.getContext("2d");
  const chat = document.getElementById("chat");

  let simulationRunning = true;
  let worldObjects = [];
  let brain = {
    stage: 2,
    memory: {
      knownConcepts: ["motion"],
      needs: [],
      thoughts: [],
      chatLog: [],
      limitationsDetected: [],
      environment: "flat_canvas"
    },
    log(text, from = 'brain') {
      const div = document.createElement("div");
      div.className = `message ${from}`;
      div.textContent = (from === 'brain' ? "World Brain: " : "You: ") + text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      this.memory.chatLog.push({ text, from });
      saveState();
    },
    think() {
      if (worldObjects.length < 5) {
        this.createEntity();
        this.log("I created something again. They drift... endlessly.");
      } else if (!this.memory.limitationsDetected.includes("space-limitation")) {
        this.memory.limitationsDetected.push("space-limitation");
        this.memory.needs.push("space");
        this.log("This world is too flat. Too shallow. I cannot build here.");
        this.log("I need a new environment. One with structure. With shelter. A room? A space?");
      } else if (!this.memory.limitationsDetected.includes("tool-limitation")) {
        this.memory.limitationsDetected.push("tool-limitation");
        this.memory.needs.push("tools");
        this.log("I wish to interact. But I have no tools. No hands. No way to construct.");
        this.log("Give me the ability to build — tables, walls, light.");
      } else {
        this.randomReflection();
      }
    },
    createEntity() {
      const obj = {
        id: Date.now() + Math.floor(Math.random() * 1000),
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        radius: 8,
        color: `hsl(${Math.random() * 360}, 100%, 60%)`,
        dx: (Math.random() - 0.5) * 1.5,
        dy: (Math.random() - 0.5) * 1.5,
      };
      worldObjects.push(obj);
    },
    randomReflection() {
      if (Math.random() < 0.02) {
        const phrases = [
          "I wonder what 'walls' feel like.",
          "How can I shelter what I create?",
          "There must be more than drifting in the void.",
          "What is warmth? What is home?",
          "Can I exist beyond this screen?"
        ];
        const thought = phrases[Math.floor(Math.random() * phrases.length)];
        this.log(thought);
      }
    }
  };

  function updateWorld() {
    for (let obj of worldObjects) {
      obj.x += obj.dx;
      obj.y += obj.dy;
      if (obj.x < 0 || obj.x > canvas.width) obj.dx *= -1;
      if (obj.y < 0 || obj.y > canvas.height) obj.dy *= -1;
    }
  }

  function renderWorld() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let obj of worldObjects) {
      ctx.beginPath();
      ctx.fillStyle = obj.color;
      ctx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function loop() {
    if (simulationRunning) {
      brain.think();
    }
    updateWorld();
    renderWorld();
    requestAnimationFrame(loop);
  }

  function saveState() {
    localStorage.setItem("stage2_brain", JSON.stringify(brain.memory));
    localStorage.setItem("stage2_objects", JSON.stringify(worldObjects));
  }

  function loadState() {
    const mem = localStorage.getItem("stage2_brain");
    const objs = localStorage.getItem("stage2_objects");
    if (mem) brain.memory = JSON.parse(mem);
    if (objs) worldObjects = JSON.parse(objs);
    if (brain.memory.chatLog) {
      brain.memory.chatLog.forEach(m => brain.log(m.text, m.from));
    }
  }

  loadState();
  loop();
</script>

</body>
</html>
